# STEPS LEVEL TEMPLATE:
# Used to build Unreal Gdk
# Reusable
# Used to "hide" the additional variables specific to this SDK which shouldn't be set from a higher level, or
#   shared from a multi-build pipeline like a publish

parameters:
- name: ApiSpecSource
  displayName: ApiSpecSource
  type: string
  default: -apiSpecGitUrl https://raw.githubusercontent.com/PlayFab/API_Specs/master/
- name: CommitMessage
  displayName: CommitMessage
  type: string
  default: Automated build from ADO Pipeline
- name: GitDestBranch
  displayName: GitDestBranch
  type: string
  default: doNotCommit
- name: SdkName
  displayName: SdkName
  type: string
  default: UnrealMarketplacePlugin
- name: ueVersion
  displayName: ueVersion
  type: string
  default: 4.25
- name: SelfTemplateResource
  displayName: SelfTemplateResource
  type: string
  default: self

steps:
- checkout: JenkinsSdkSetupScripts
  clean: true
  path: s
- checkout: API_Specs
  clean: true
  path: s/API_Specs
- checkout: SdkGenerator
  clean: true
  path: s/SdkGenerator
- checkout: ${{ parameters.SelfTemplateResource }}
  clean: true
  submodules: true
  path: s/SdkGenerator/privateTemplates/UnrealMarketplacePlugin
- checkout: UnrealMarketplacePlugin
  clean: true
  submodules: true
  path: s/sdks/UnrealMarketplacePlugin
  persistCredentials: true
- bash: |
    set -e

    echo alias the ADO variables into local variables
    ApiSpecSource="${{ parameters.ApiSpecSource }}"
    CommitMessage="${{ parameters.CommitMessage }}"
    GitDestBranch="${{ parameters.GitDestBranch }}"
    SdkName="${{ parameters.SdkName }}"
    ueVersion="${{ parameters.ueVersion }}"
    WORKSPACE=$(pwd -W)
    # Hack attempt to get WORKSPACE into a sub-environment
    export WORKSPACE="$WORKSPACE"

    cd "$WORKSPACE/JenkinsSdkSetupScripts/JenkinsScripts/Pipeline"
    . ./testInit.sh

    . "$WORKSPACE/JenkinsSdkSetupScripts/JenkinsScripts/Pipeline/util.sh"

    cd "$WORKSPACE/SDKGenerator/SDKBuildScripts"
    targetSrc="UnrealMarketplacePlugin"
    . ./shared_build.sh

    cp "$WORKSPACE/JenkinsSdkSetupScripts/Creds/testTitleData.json" "$WORKSPACE/sdks/$SdkName/$ueVersion/ExampleProject/Content/TestTitleData/testTitleData.json"

    cd "$WORKSPACE/sdks/$SdkName/$ueVersion/ExampleProject"
    
    echo ========== BUILDING WIN GDK ==========

    uePath="C:/dev/UE4_GDK_PFP_MAIN"

    uatPath=$uePath/Engine/Build/BatchFiles/RunUAT.bat

    ufePath=$uePath/Engine/Binaries/Win64/UnrealFrontEnd.exe

    exampleProjectPath=$WORKSPACE/sdks/$SdkName/$ueVersion/ExampleProject/ExampleProject.uproject

    targetPlatform=WinGDK

    archivePath=Build/$targetPlatform

    # cmd <<< "$uatPath" BuildCookRun -rocket -installed -nop4 -nocompile -project="ExampleProject.uproject" -cook -stage -archive -archivedirectory="$archivePath" -package -clientconfig=Development -Platform=$targetPlatform -compressed -CookAll -pak -prereqs -build -utf8output -editorrecompile
    cmd <<< "$uatPath" -ScriptsForProject=$exampleProjectPath BuildCookRun -project=$exampleProjectPath -noP4 -clientconfig=Development -serverconfig=Development -utf8output -platform=$targetPlatform -targetplatform=$targetPlatform -ini:Game:[/Script/UnrealEd.ProjectPackagingSettings]:BlueprintNativizationMethod=Disabled -build -cookonthefly -map= -compressed -stage -deploy -cmdline=" -Messaging" -device=WinGDK@PF-GDK-UNREAL -addcmdline="-SessionId=816DB4BC4C4C48848A7C7A997A460E5C -SessionOwner='Administrator' -SessionName='PF-GDK-UNREAL (GDK)'  " -run -compile

    #cmd <<< "$ufePath" -RUN=PACKAGE
    #cmd <<< "$ufePath" -RUN=DEPLOY
    #cmd <<< "$ufePath" -RUN=LAUNCH

    echo ======= RUNNING TESTS WIN GDK =======

    archivePath=Build\Win64

    # this is not the correct path to expect from archive (winGDK?)
    cmd <<< call "%~dp0%archivePath%\WindowsNoEditor\ExampleProject.exe" -run=RunTests -NoShaderCompile

    . "$WORKSPACE/JenkinsSdkSetupScripts/JenkinsScripts/Pipeline/sdkUtil.sh"
    ListenCsJCU

  displayName: 'Build/Test/Report'
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '*.xml'
    testRunTitle: UnrealGdkTemplate
